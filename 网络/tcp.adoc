
:toc:

:icons: font

// 保证所有的目录层级都可以正常显示图片
:path: 网络/
:imagesdir: ../image/
:srcdir: ../src


// 只有book调用的时候才会走到这里
ifdef::rootpath[]
:imagesdir: {rootpath}{path}{imagesdir}
:srcdir: {rootpath}../src/
endif::rootpath[]

ifndef::rootpath[]
:rootpath: ../
:srcdir: {rootpath}{path}../src/
endif::rootpath[]


== tcp

- 为什么服务端程序需要先listen一下
- 半连接和全连接队列长度如何确定

> tcp服务端在处理三次握手的时候需要有半连接和全连接队列配合完成，那么这两个队列在内核中是什么样子？如何想修改他们的长度如何完成？

- cannot assign requested address这个报错你知道是怎么回事吗？该如何解决
- 一个客户端端口可以同时用在两个连接上吗？

> 假设一个客户端某个端口号已经和某个服务端建立连接了，那么再想和其他服务端建立连接这个端口还能用吗？

- 服务端的全连接和半连接全满了会怎么样？

> 如果服务端连接请求过于频繁，导致全连接和半连接全部都满了会怎样？会不会导致线上问题？会不会导致连接队列溢出，如果有，怎么办？怎样才能解决？

- 创建新连接时，新连接的socket内核对象是什么时候创建的？
- 建立一条tcp连接需要消耗多长时间？
- 服务器负载正常但是CPU被打到底(100%)了是怎么回事？


.网络协议栈
image::../image/image-2023-06-07-15-23-19-171.png[网络协议栈, , align="center"]


=== 深入理解listen

在开启服务之前总是会调用一下listen系统接口，那这个底层干了啥？为啥服务端需要调用客户端不需要调用？

==== 系统函数

socket函数的定义在net/socket.c文件中。具体实现如下：

.file net/socket.c
[source, cpp]
----

/*
 *	Perform a listen. Basically, we allow the protocol to do anything
 *	necessary for a listen, and if that works, we mark the socket as
 *	ready for listening.
 */

SYSCALL_DEFINE2(listen, int, fd, int, backlog)
{
	struct socket *sock;
	int err, fput_needed;
	int somaxconn;

	sock = sockfd_lookup_light(fd, &err, &fput_needed);
	if (sock) {
	    // 获取内核参数 net.core.somaxconn - 内核配置允许最大的连接队列个数
		somaxconn = sock_net(sock->sk)->core.sysctl_somaxconn;
		if ((unsigned int)backlog > somaxconn)
			backlog = somaxconn;

		err = security_socket_listen(sock, backlog);
		if (!err)  // 使用协议栈注册进来的listen函数
			err = sock->ops->listen(sock, backlog);

		fput_light(sock->file, fput_needed);
	}
	return err;
}
----

用户使用的socket文件描述符，只是一个整数，内核是没有办法使用的，所以实际使用中需要根据用户提供的整数查找出内核使用的socket对象。



































参考：

https://mp.weixin.qq.com/s?__biz=MzA3NjY2NzY1MA==&mid=2649740393&idx=1&sn=b048e8e068052549af0c44cb678a7140&chksm=8746ba04b0313312fe87e346c0c68d235a8e81b31de1453392427af6384e612ad44713627eb0&scene=27[eBPF内核协议栈背负太多的历史包袱]
https://mp.weixin.qq.com/s/uWRg1fhHZh_ttd2NUsAh9w[XDPF/eBPF]
https://mp.weixin.qq.com/s/TwKOwg2RFBYKZF160Zw7lA[一个奇葩的网络问题]









