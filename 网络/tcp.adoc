
:toc:

:icons: font

// 保证所有的目录层级都可以正常显示图片
:path: 网络/
:imagesdir: ../image/
:srcdir: ../src


// 只有book调用的时候才会走到这里
ifdef::rootpath[]
:imagesdir: {rootpath}{path}{imagesdir}
:srcdir: {rootpath}../src/
endif::rootpath[]

ifndef::rootpath[]
:rootpath: ../
:srcdir: {rootpath}{path}../src/
endif::rootpath[]

== tcp


=== tcp哪些不得不知的事情

.TCP
****
TCP很复杂，复杂到难以想象，很多人抱怨为什么TCP不能精简点，有这样想法的人是没有看TCP的发展史。因为实际网络中的各种不确定情况都需要靠TCP来解决，而这些问题还会导致一些列子问题，问题带问题子子孙孙无穷尽已。但是这并不是说TCP不值得学，而是TCP太值得学习了，你通过学习TCP能学习很多问题的解决方案，也能学习到很多best practice，而这些都是经过无数次实践检验的宝贵经验。
****

- 为什么要记录那么多，因为TCP真他妈太复杂了，不记录一些知识点肯定会被忘记的
- 经过30多年的修改，TCP的复杂程度已经到了无以复加的程度，所以很多组织和公司开始绕过内核的tcp来实现一些功能如：DPDK, XDP













=== TCP连接建立过程

- 为什么服务端程序需要先listen一下
- 半连接和全连接队列长度如何确定

> tcp服务端在处理三次握手的时候需要有半连接和全连接队列配合完成，那么这两个队列在内核中是什么样子？如何想修改他们的长度如何完成？

- cannot assign requested address这个报错你知道是怎么回事吗？该如何解决
- 一个客户端端口可以同时用在两个连接上吗？

> 假设一个客户端某个端口号已经和某个服务端建立连接了，那么再想和其他服务端建立连接这个端口还能用吗？

- 服务端的全连接和半连接全满了会怎么样？

> 如果服务端连接请求过于频繁，导致全连接和半连接全部都满了会怎样？会不会导致线上问题？会不会导致连接队列溢出，如果有，怎么办？怎样才能解决？

- 创建新连接时，新连接的socket内核对象是什么时候创建的？
- 建立一条tcp连接需要消耗多长时间？
- 服务器负载正常但是CPU被打到底(100%)了是怎么回事？


.网络协议栈
image::../image/image-2023-06-07-15-23-19-171.png[网络协议栈, , align="center"]


=== 深入理解listen









参考：

https://mp.weixin.qq.com/s?__biz=MzA3NjY2NzY1MA==&mid=2649740393&idx=1&sn=b048e8e068052549af0c44cb678a7140&chksm=8746ba04b0313312fe87e346c0c68d235a8e81b31de1453392427af6384e612ad44713627eb0&scene=27[eBPF内核协议栈背负太多的历史包袱]
https://mp.weixin.qq.com/s/uWRg1fhHZh_ttd2NUsAh9w[XDPF/eBPF]
https://mp.weixin.qq.com/s/TwKOwg2RFBYKZF160Zw7lA[一个奇葩的网络问题]

https://coolshell.cn/articles/11564.html[tcp那些事]









